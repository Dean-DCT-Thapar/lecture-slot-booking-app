<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book a Slot - Slot Booking System</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='teacher_slots.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="booking-wrapper">
        <!-- Modern Header -->
        <header class="booking-header">
            <div class="header-content">
                <div class="page-title">
                    <div class="title-icon">üìÖ</div>
                    <div class="title-text">
                        <h1>Book a Slot</h1>
                        <p>Select your preferred date and time</p>
                    </div>
                </div>
                <a href="{{ url_for('teacher_dashboard') }}" class="back-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Back to Dashboard
                </a>
            </div>
        </header>

        <!-- Main Content -->
        <main class="booking-main">
            <div class="container">
                <!-- Calendar Section -->
                <div id="calendar-view" class="calendar-section">
                    <div class="section-header">
                        <h2>Available Dates</h2>
                        <p>Click on any available date to view time slots</p>
                    </div>
                    
                    <div class="calendar-container">
                        <div class="months-grid">
                            {% set months = calendar_days|groupby('month') %}
                            {% for month, days_in_month in months %}
                                <div class="month-card">
                                    <div class="month-header">
                                        <h3>{{ days_in_month[0].strftime('%B %Y') }}</h3>
                                    </div>
                                    
                                    <!-- Weekday headers -->
                                    <div class="weekdays">
                                        <div class="weekday">Sun</div>
                                        <div class="weekday">Mon</div>
                                        <div class="weekday">Tue</div>
                                        <div class="weekday">Wed</div>
                                        <div class="weekday">Thu</div>
                                        <div class="weekday">Fri</div>
                                        <div class="weekday">Sat</div>
                                    </div>
                                    
                                    <!-- Calendar grid -->
                                    <div class="calendar-grid">
                                        {% set first_weekday = (days_in_month[0].weekday() + 1) % 7 %}
                                        {% for _ in range(first_weekday) %}
                                            <div class="calendar-day empty"></div>
                                        {% endfor %}
                                        {% for day in days_in_month %}
                                            {% set date_str = day.strftime('%Y-%m-%d') %}
                                            <div class="calendar-day {% if date_str in available_dates %}available{% else %}unavailable{% endif %}"
                                                 data-date="{{ date_str }}"
                                                 {% if date_str in available_dates %}tabindex="0"{% endif %}>
                                                <span class="day-number">{{ day.day }}</span>
                                                {% if date_str in available_dates %}
                                                    <div class="availability-indicator"></div>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Slots Section -->
                <div id="slots-view" class="slots-section" style="display:none;">
                    <div class="slots-header">
                        <button class="back-to-calendar-btn" id="back-to-calendar">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Back to Calendar
                        </button>
                        <div class="selected-date-info">
                            <h2>Available Time Slots</h2>
                            <p id="selected-date-display">Select your preferred time</p>
                        </div>
                    </div>
                    
                    <div id="slots-content" class="slots-content">
                        <!-- Slots will be loaded here dynamically -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Handle calendar day clicks
        document.querySelectorAll('.calendar-day.available').forEach(day => {
            day.addEventListener('click', function() {
                const date = this.getAttribute('data-date');
                const dateObj = new Date(date);
                const formattedDate = dateObj.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                // Update selected date display
                document.getElementById('selected-date-display').textContent = formattedDate;
                
                // Show loading state
                document.getElementById('slots-content').innerHTML = `
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <p>Loading available slots...</p>
                    </div>
                `;
                
                // Fetch slots for the selected date
                fetch(`{{ url_for('teacher_slots') }}?date=${date}`, {
                    headers: {'X-Requested-With': 'XMLHttpRequest'}
                })
                .then(response => response.text())
                .then(html => {
                    document.getElementById('slots-content').innerHTML = html;
                    document.getElementById('calendar-view').style.display = 'none';
                    document.getElementById('slots-view').style.display = 'block';
                    
                    // Scroll to top of slots section
                    document.getElementById('slots-view').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                })
                .catch(error => {
                    document.getElementById('slots-content').innerHTML = `
                        <div class="error-state">
                            <div class="error-icon">‚ùå</div>
                            <h3>Error Loading Slots</h3>
                            <p>Unable to load available time slots. Please try again.</p>
                            <button onclick="location.reload()" class="retry-btn">Retry</button>
                        </div>
                    `;
                });
            });
            
            // Add keyboard navigation
            day.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
            
            // Add hover effects
            day.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-1px)';
            });
            
            day.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });

        // Back to calendar functionality
        document.getElementById('back-to-calendar').addEventListener('click', function() {
            document.getElementById('slots-view').style.display = 'none';
            document.getElementById('calendar-view').style.display = 'block';
            document.getElementById('slots-content').innerHTML = '';
            
            // Scroll back to calendar
            document.getElementById('calendar-view').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        });

        // Add staggered animation to calendar days
        document.querySelectorAll('.calendar-day').forEach((day, index) => {
            day.style.animationDelay = `${(index % 35) * 0.02}s`;
        });
    </script>
</body>
</html>